<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Conexão Saber - Escola</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <div class="container py-4">
    <h1 class="h4 mb-3">Conexão Saber - Sua Conexão com o Futuro</h1>

    <div id="auth" class="card p-3 mb-3">
      <h2 class="h6">Login / Cadastro (Escola)</h2>
      <input id="s_email" class="form-control mb-2" placeholder="E-mail da instituição">
      <input id="s_password" type="password" class="form-control mb-2" placeholder="Senha">
      <div class="d-flex gap-2">
        <button id="s_login" class="btn btn-primary flex-grow-1">Entrar</button>
        <button id="s_register" class="btn btn-outline-secondary flex-grow-1">Cadastrar</button>
      </div>
    </div>

    <div id="panel" style="display:none">
      <div class="card p-3 mb-3">
        <h5>Nova aula / curso</h5>
        <input id="courseTitle" class="form-control mb-2" placeholder="Título do curso">
        <input id="courseTeacher" class="form-control mb-2" placeholder="Professor">
        <textarea id="courseDesc" class="form-control mb-2" placeholder="Descrição"></textarea>
        <button id="addCourse" class="btn btn-success">Adicionar Aula</button>
      </div>
      <div id="coursesArea"></div>
      <button id="logout" class="btn btn-danger mt-3">Sair</button>
    </div>
  </div>

<script>
const API = window.location.origin + '/conexaosaber_repo/api.php';

async function apiGet(){
  const res = await fetch(API);
  return await res.json();
}

async function apiPost(action, payload){
  const res = await fetch(API + '?action=' + action, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  return await res.json();
}

const auth = document.getElementById('auth');
const panel = document.getElementById('panel');
const s_email = document.getElementById('s_email');
const s_password = document.getElementById('s_password');
const s_login = document.getElementById('s_login');
const s_register = document.getElementById('s_register');
const addCourse = document.getElementById('addCourse');
const coursesArea = document.getElementById('coursesArea');
const logout = document.getElementById('logout');

s_register.addEventListener('click', async ()=>{
  const resp = await apiPost('register_school', {email: s_email.value, password: s_password.value, name: s_email.value});
  if(resp.ok) alert('Escola cadastrada'); else alert(resp.error || 'Erro');
});

s_login.addEventListener('click', async ()=>{
  const resp = await apiPost('login_school', {email: s_email.value, password: s_password.value});
  if(resp.ok){ sessionStorage.setItem('integra_school', JSON.stringify(resp.school)); startPanel(); } else alert(resp.error || 'Credenciais inválidas');
});

function startPanel(){
  const s = JSON.parse(sessionStorage.getItem('integra_school'));
  if(!s) return;
  auth.style.display='none'; panel.style.display='block';
  renderCourses();
}

addCourse.addEventListener('click', async ()=>{
  const title = document.getElementById('courseTitle').value;
  const teacher = document.getElementById('courseTeacher').value;
  const desc = document.getElementById('courseDesc').value;
  if(!title) return alert('Título obrigatório');
  const resp = await apiPost('add_course', {title, teacher, description: desc});
  if(resp.ok){ alert('Curso criado'); renderCourses(); } else alert(resp.error || 'Erro');
});

async function renderCourses(){
  const data = await apiGet();
  coursesArea.innerHTML = '';
  (data.courses || []).forEach(c=>{
    let lessonsHtml = '';
    (c.lessons || []).forEach((l,i)=>{
      lessonsHtml += `
        <li class="list-group-item d-flex justify-content-between align-items-center">
          <span>
            <strong>${i+1} — ${l.title}</strong><br>
            <small class="text-muted">${l.url}</small>
          </span>
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-primary" onclick="editLesson(${c.id}, ${i})">Editar</button>
            <button class="btn btn-outline-danger" onclick="deleteLesson(${c.id}, ${i})">Remover</button>
          </div>
        </li>`;
    });

    const card = document.createElement('div');
    card.className='card mb-3 p-3';
    card.innerHTML = `
      <h5 class="mb-1">${c.title}</h5>
      <div class="mb-2 text-muted small">${c.teacher}</div>
      <p>${c.description||''}</p>
      <div class="mb-2">
        <button class="btn btn-sm btn-outline-success" onclick="addLesson(${c.id})">Adicionar Aula</button>
        <button class="btn btn-sm btn-danger" onclick="deleteCourse(${c.id})">Remover Curso</button>
      </div>
      <ul class="list-group">${lessonsHtml}</ul>
    `;
    coursesArea.appendChild(card);
  });
}

async function editLesson(courseId, lessonIndex){
  const newTitle = prompt('Novo título da aula:');
  const newUrl = prompt('Novo link da aula:');
  if(!newTitle || !newUrl) return alert('Preencha título e link');

  const resp = await apiPost('edit_lesson', {course_id: courseId, lesson_index: lessonIndex, title: newTitle, url: newUrl});
  if(resp.ok){
    alert('Aula atualizada com sucesso');
    renderCourses();
  } else {
    alert(resp.error || 'Erro ao atualizar aula');
  }
}

async function deleteLesson(courseId, lessonIndex){
  if(!confirm('Remover esta aula?')) return;
  const resp = await apiPost('delete_lesson', {course_id: courseId, lesson_index: lessonIndex});
  if(resp.ok){
    alert('Aula removida');
    renderCourses();
  } else {
    alert(resp.error || 'Erro ao remover aula');
  }
}

async function addLesson(id){
  const title = prompt('Título da aula');
  const url = prompt('URL da aula (YouTube, link público ou arquivo)');
  if(!title || !url) return alert('Título e URL necessários');
  const resp = await apiPost('add_lesson', {course_id: id, title, url});
  if(resp.ok) alert('Aula adicionada'); else alert(resp.error || 'Erro');
  renderCourses();
}

// Função para remover curso
async function deleteCourse(courseId){
  if(!confirm('Remover este curso?')) return;
  const resp = await apiPost('delete_course', { course_id: courseId });
  if(resp.ok){
    alert('Curso removido com sucesso');
    renderCourses();
  } else {
    alert(resp.error || 'Erro ao remover curso');
  }
}

logout.addEventListener('click', ()=>{ sessionStorage.removeItem('integra_school'); location.reload(); });

if(sessionStorage.getItem('integra_school')) startPanel();
</script>
</body>
</html>
